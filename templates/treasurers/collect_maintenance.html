{% extends "layout/base.html" %}
{% block title %}Maintenance Collection{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom: 35px;">
    <h1>ðŸ§¾ Maintenance Collection</h1>
    <p style="color: #64748b;">Record current or <strong>advance</strong> payments for residents.</p>
</div>

<div class="card" style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); max-width: 800px; margin: 20px auto; border: 1px solid #f1f5f9;">
    <form method="POST">
        
        <!-- 1. PROPERTY SELECTION -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
            <div>
                <label style="display:block; margin-bottom:10px; font-weight:700; font-size:13px; color: #475569;">SELECT BLOCK</label>
                <select id="block_selector" required style="width:100%; padding:12px; border-radius:12px; border:1.5px solid #e2e8f0; background:white; cursor: pointer; outline: none;">
                    <option value="">-- Choose Block --</option>
                    {% for b in blocks %}
                        <option value="{{ b.id }}">{{ b.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label style="display:block; margin-bottom:10px; font-weight:700; font-size:13px; color: #475569;">SELECT FLAT</label>
                <select name="flat_id" id="flat_selector" required disabled style="width:100%; padding:12px; border-radius:12px; border:1.5px solid #e2e8f0; background:#f8fafc; cursor: pointer; outline: none;">
                    <option value="">-- Select Block First --</option>
                </select>
            </div>
        </div>

        <!-- 2. DYNAMIC STATUS BOX (Hidden until flat selected) -->
        <div style="background: #eef2ff; padding: 20px; border-radius: 16px; margin-bottom: 30px; display: none; border: 1px solid #bae6fd;" id="status_box">
            <p style="margin: 0; color: #0369a1; font-size: 14px; font-weight: 700;">
                ðŸ“… Payment Starts From: <span id="starting_period_text">Please wait...</span>
            </p>
            <!-- Hidden inputs to send start dates to the server -->
            <input type="hidden" name="start_month" id="hidden_start_month">
            <input type="hidden" name="start_year" id="hidden_start_year">
        </div>

        <!-- 3. AMOUNT -->
        <div style="margin-bottom: 35px;">
            <label style="display:block; margin-bottom:10px; font-weight:700; font-size:13px; color: #475569;">MONTHLY AMOUNT (â‚¹)</label>
            <input type="number" name="amount" required value="1500" style="width:100%; padding:12px; border-radius:12px; border:1.5px solid #e2e8f0; outline: none; font-size: 15px;">
        </div>

        <!-- 4. ADVANCE DURATION -->
        <div style="border-top: 2px solid #f1f5f9; padding-top: 30px;">
            <h3 style="font-size: 14px; color: #1e293b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; font-weight: 800;">Advance Payment Until</h3>
            
            <div style="display: flex; gap: 15px; align-items: center; background: #f8fafc; padding: 20px; border-radius: 12px;">
                <select name="end_month" required style="flex: 2; padding:12px; border-radius:10px; border:1.5px solid #e2e8f0; background: white; outline: none;">
                    {% for m in ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"] %}
                        <option value="{{ m }}">{{ m }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="end_year" value="2026" required style="flex: 1; padding:12px; border-radius:10px; border:1.5px solid #e2e8f0; outline: none;">
            </div>
        </div>

        <!-- 5. ACTIONS -->
        <div style="margin-top: 40px; display: flex; gap: 15px; align-items: center;">
            <button type="submit" id="submit_btn" disabled 
                    style="flex: 2; background: #94a3b8; color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 700; cursor: not-allowed; font-size: 16px; transition: all 0.3s ease;">
                Select a Flat to Continue
            </button>
            <a href="{{ url_for('dashboard.index') }}" style="flex: 1; text-align: center; color: #64748b; text-decoration: none; font-weight: 600; font-size: 15px;">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
const blockSelect = document.getElementById('block_selector');
const flatSelect = document.getElementById('flat_selector');
const statusBox = document.getElementById('status_box');
const startText = document.getElementById('starting_period_text');
const submitBtn = document.getElementById('submit_btn');

// 1. Logic to load flats based on block
blockSelect.addEventListener('change', function() {
    flatSelect.disabled = true;
    statusBox.style.display = 'none';
    submitBtn.disabled = true;
    submitBtn.innerText = "Select a Flat to Continue";
    submitBtn.style.background = "#94a3b8";
    submitBtn.style.cursor = "not-allowed";

    if (!this.value) return;

    fetch(`/treasurers/get-occupied-flats/${this.value}`)
        .then(res => res.json())
        .then(data => {
            flatSelect.innerHTML = '<option value="">-- Select Flat --</option>';
            data.flats.forEach(f => {
                flatSelect.innerHTML += `<option value="${f.id}">${f.flat_number}</option>`;
            });
            flatSelect.disabled = false;
            flatSelect.style.background = 'white';
        });
});

// 2. Logic to detect starting point and enable button
flatSelect.addEventListener('change', function() {
    if(!this.value) { 
        statusBox.style.display = 'none'; 
        submitBtn.disabled = true;
        return; 
    }

    statusBox.style.display = 'block';
    startText.innerText = "Checking records...";
    submitBtn.disabled = true; // Stay disabled until fetch finishes
    submitBtn.innerText = "Loading history...";

    fetch(`/treasurers/get-next-unpaid/${this.value}`)
        .then(res => res.json())
        .then(data => {
            if(data.month) {
                startText.innerText = `${data.month} ${data.year}`;
                document.getElementById('hidden_start_month').value = data.month;
                document.getElementById('hidden_start_year').value = data.year;
                
                // ENABLE BUTTON
                submitBtn.disabled = false;
                submitBtn.innerText = "ðŸš€ Process Payment";
                submitBtn.style.background = "#4e46e5";
                submitBtn.style.cursor = "pointer";
            }
        });
});
</script>
{% endblock %}